#include <linux/delay.h>
#include <linux/module.h>
#include <linux/of_platform.h>
#include <linux/platform_device.h>
#include <linux/serial_8250.h>
#include <drm/drm_connector.h>
#include <drm/drm_crtc.h>
#include <drm/drm_panel.h>
#include <video/of_display_timing.h>
#include <video/of_videomode.h>
#include <video/videomode.h>
#include <linux/string.h>
#include <linux/serial_dw8250.h>

#define MAX96789_UART_READ_ADDR 	0xC5
#define MAX96789_UART_WRITE_ADDR	0xC4
#define MAX96745_UART_READ_ADDR 	0xC5
#define MAX96745_UART_WRITE_ADDR	0xC4
#define MAX96752_UART_READ_ADDR 	0x91
#define MAX96752_UART_WRITE_ADDR	0x90

#define SERI_ID MAX96789_UART_WRITE_ADDR
#define DSER_ID MAX96752_UART_WRITE_ADDR

//asymmetric config for 1920  1080p+720p
unsigned char reg_cmds_asym[][7] = {
	{0x79, SERI_ID, 0x03, 0x80, 0x01, 0x0f, 200}, // serial sync mode auto ,low level active
	//#Asymmetric 9_26_17-23 Using MAX96789/91/F (GMSL-1/2)
	//#Set Stream ID = 0 for GMSL PHY A
	{0x79, SERI_ID, 0x00, 0x53, 0x01, 0x10, 00},
	//#Set Stream ID = 1 for GMSL PHY B
	{0x79, SERI_ID, 0x00, 0x57, 0x01, 0x21, 00},
	//#Set Port A Lane Mapping
	{0x79, SERI_ID, 0x03 , 0x32, 0x01, 0x4E, 00},
	//#Set Port B Lane Mapping
	{0x79, SERI_ID, 0x03 , 0x33, 0x01, 0xE4, 00},
	//#Set GMSL type
	{0x79, SERI_ID, 0x00, 0x04, 0x01, 0xF2, 00},
	//#Clock Select
	{0x79, SERI_ID, 0x03 , 0x08, 0x01, 0x5C, 00},
	//#Start DSI Port
	{0x79, SERI_ID, 0x03 , 0x11, 0x01, 0x03, 00},
	//#Number of Lanes
	{0x79, SERI_ID, 0x03 , 0x31, 0x01, 0x03, 00},
	//#Set phy_config
	{0x79, SERI_ID, 0x03 , 0x30, 0x01, 0x06, 00},
	//#Set soft_dtx_en
	{0x79, SERI_ID, 0x03 , 0x1C, 0x01, 0x98, 00},
	//#Set soft_dtx
	{0x79, SERI_ID, 0x03 , 0x21, 0x01, 0x24, 00},
	//#Set soft_dty_en
	{0x79, SERI_ID, 0x03 , 0x1D, 0x01, 0x98, 00},
	//#Set soft_dty
	{0x79, SERI_ID, 0x03 , 0x22, 0x01, 0x24, 00},
	//#Init Default
	{0x79, SERI_ID, 0x03 , 0x26, 0x01, 0xE4, 00},
	//#HSYNC_WIDTH_L
	{0x79, SERI_ID, 0x03 , 0x85, 0x01, 0x34, 00},
	//#VSYNC_WIDTH_L
	{0x79, SERI_ID, 0x03 , 0x86, 0x01, 0x0C, 00},
	//#HSYNC_WIDTH_H/VSYNC_WIDTH_H
	{0x79, SERI_ID, 0x03 , 0x87, 0x01, 0x00, 00},
	//#VFP_L
	{0x79, SERI_ID, 0x03 , 0xA5, 0x01, 0x45, 00},
	//#VBP_H
	{0x79, SERI_ID, 0x03 , 0xA7, 0x01, 0x00, 00},
	//#VFP_H/VBP_L
	{0x79, SERI_ID, 0x03 , 0xA6, 0x01, 0xC0, 00},
	//#VRES_L
	{0x79, SERI_ID, 0x03 , 0xA8, 0x01, 0x38, 00},
	//#VRES_H
	{0x79, SERI_ID, 0x03 , 0xA9, 0x01, 0x04, 00},
	//#HFP_L
	{0x79, SERI_ID, 0x03 , 0xAA, 0x01, 0xC8, 00},
	//#HBP_H
	{0x79, SERI_ID, 0x03 , 0xAC, 0x01, 0x03, 00},
	//#HFP_H/HBP_L
	{0x79, SERI_ID, 0x03 , 0xAB, 0x01, 0x41, 00},
	//#HRES_L
	{0x79, SERI_ID, 0x03 , 0xAD, 0x01, 0x00, 00},
	//#HRES_H
	{0x79, SERI_ID, 0x03 , 0xAE, 0x01, 0x0F, 00},
	//#FIFO/DESKEW_EN
	{0x79, SERI_ID, 0x03 , 0xA4, 0x01, 0xC1, 00},
	//# ASYM_REGS
	{0x79, SERI_ID, 0x07 , 0x00, 0x01, 0x78, 00},
	{0x79, SERI_ID, 0x07 , 0x01, 0x01, 0x60, 00},
	{0x79, SERI_ID, 0x07 , 0x02, 0x01, 0x27, 00},
	{0x79, SERI_ID, 0x07 , 0x03, 0x01, 0x50, 00},
	{0x79, SERI_ID, 0x07 , 0x04, 0x01, 0x40, 00},
	{0x79, SERI_ID, 0x07 , 0x05, 0x01, 0x1A, 00},
	{0x79, SERI_ID, 0x07 , 0x06, 0x01, 0xF0, 00},
	{0x79, SERI_ID, 0x07 , 0x07, 0x01, 0xC0, 00},
	{0x79, SERI_ID, 0x07 , 0x08, 0x01, 0x4E, 00},
	{0x79, SERI_ID, 0x07 , 0x09, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x0A, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x0B, 0x01, 0x80, 00},
	{0x79, SERI_ID, 0x07 , 0x0C, 0x01, 0x07, 00},
	{0x79, SERI_ID, 0x07 , 0x0D, 0x01, 0x38, 00},
	{0x79, SERI_ID, 0x07 , 0x0E, 0x01, 0x04, 00},
	{0x79, SERI_ID, 0x07 , 0x0F, 0x01, 0x80, 00},
	{0x79, SERI_ID, 0x07 , 0x10, 0x01, 0x07, 00},
	{0x79, SERI_ID, 0x07 , 0x11, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x12, 0x01, 0x0F, 00},
	{0x79, SERI_ID, 0x07 , 0x13, 0x01, 0x38, 00},
	{0x79, SERI_ID, 0x07 , 0x14, 0x01, 0x04, 00},
	{0x79, SERI_ID, 0x07 , 0x15, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x16, 0x01, 0x50, 00},
	{0x79, SERI_ID, 0x07 , 0x17, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x18, 0x01, 0x10, 00},
	//# ASYM_READ_REGS_A
	{0x79, SERI_ID, 0x07 , 0x20, 0x01, 0x38, 00},
	{0x79, SERI_ID, 0x07 , 0x21, 0x01, 0x92, 00},
	{0x79, SERI_ID, 0x07 , 0x22, 0x01, 0x26, 00},
	{0x79, SERI_ID, 0x07 , 0x23, 0x01, 0x20, 00},
	{0x79, SERI_ID, 0x07 , 0x24, 0x01, 0x67, 00},
	{0x79, SERI_ID, 0x07 , 0x25, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x26, 0x01, 0x20, 00},
	{0x79, SERI_ID, 0x07 , 0x27, 0x01, 0x67, 00},
	{0x79, SERI_ID, 0x07 , 0x28, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x29, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x2A, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x2B, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x2C, 0x01, 0x14, 00},
	{0x79, SERI_ID, 0x07 , 0x2D, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x2E, 0x01, 0x84, 00},
	{0x79, SERI_ID, 0x07 , 0x2F, 0x01, 0x08, 00},
	{0x79, SERI_ID, 0x07 , 0x30, 0x01, 0x95, 00},
	{0x79, SERI_ID, 0x07 , 0x31, 0x01, 0x04, 00},
	{0x79, SERI_ID, 0x07 , 0x32, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x33, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x34, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x35, 0x01, 0x28, 00},
	{0x79, SERI_ID, 0x07 , 0x36, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x37, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x38, 0x01, 0x80, 00},
	{0x79, SERI_ID, 0x07 , 0x39, 0x01, 0x07, 00},
	{0x79, SERI_ID, 0x07 , 0x3A, 0x01, 0x18, 00},
	{0x79, SERI_ID, 0x07 , 0x3B, 0x01, 0x01, 00},
	{0x79, SERI_ID, 0x07 , 0x3C, 0x01, 0x38, 00},
	{0x79, SERI_ID, 0x07 , 0x3D, 0x01, 0x04, 00},
	{0x79, SERI_ID, 0x07 , 0x3E, 0x01, 0x10, 00},
	{0x79, SERI_ID, 0x07 , 0x3F, 0x01, 0x1F, 00},
	{0x79, SERI_ID, 0x07 , 0x40, 0x01, 0x03, 00},
	//# ASYM_READ_REGS_B
	{0x79, SERI_ID, 0x07 , 0x50, 0x01, 0xD0, 00},
	{0x79, SERI_ID, 0x07 , 0x51, 0x01, 0xB6, 00},
	{0x79, SERI_ID, 0x07 , 0x52, 0x01, 0x19, 00},
	{0x79, SERI_ID, 0x07 , 0x53, 0x01, 0xC0, 00},
	{0x79, SERI_ID, 0x07 , 0x54, 0x01, 0x44, 00},
	{0x79, SERI_ID, 0x07 , 0x55, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x56, 0x01, 0xC0, 00},
	{0x79, SERI_ID, 0x07 , 0x57, 0x01, 0x44, 00},
	{0x79, SERI_ID, 0x07 , 0x58, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x59, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x5A, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x5B, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x5C, 0x01, 0x20, 00},
	{0x79, SERI_ID, 0x07 , 0x5D, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x5E, 0x01, 0x78, 00},
	{0x79, SERI_ID, 0x07 , 0x5F, 0x01, 0x08, 00},
	{0x79, SERI_ID, 0x07 , 0x60, 0x01, 0x0E, 00},
	{0x79, SERI_ID, 0x07 , 0x61, 0x01, 0x03, 00},
	{0x79, SERI_ID, 0x07 , 0x62, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x63, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x64, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x65, 0x01, 0x40, 00},
	{0x79, SERI_ID, 0x07 , 0x66, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x67, 0x01, 0x00, 00},
	{0x79, SERI_ID, 0x07 , 0x68, 0x01, 0x80, 00},
	{0x79, SERI_ID, 0x07 , 0x69, 0x01, 0x07, 00},
	{0x79, SERI_ID, 0x07 , 0x6A, 0x01, 0x18, 00},
	{0x79, SERI_ID, 0x07 , 0x6B, 0x01, 0x01, 00},
	{0x79, SERI_ID, 0x07 , 0x6C, 0x01, 0xD0, 00},
	{0x79, SERI_ID, 0x07 , 0x6D, 0x01, 0x02, 00},
	{0x79, SERI_ID, 0x07 , 0x6E, 0x01, 0x90, 00},
	{0x79, SERI_ID, 0x07 , 0x6F, 0x01, 0x14, 00},
	{0x79, SERI_ID, 0x07 , 0x70, 0x01, 0x02, 00},
	//#Select LUT pattern/ Enable ASYM
	{0x79, SERI_ID, 0x07 , 0x19, 0x01, 0x57, 00},
	//#Video Pipe Enable
	{0x79, SERI_ID, 0x00, 0x02, 0x01, 0x33, 0},
	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x23, 100},

	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x21, 100},
	{0x79, DSER_ID, 0x00, 0x50, 0x01, 0x00, 100},
	{0x79, DSER_ID, 0x01, 0xCE, 0x01, 0x5F, 100},//5F
	{0x79, DSER_ID, 0x00, 0x01, 0x01, 0x02, 0},
	{0x79, SERI_ID, 0x00, 0x01, 0x01, 0x08, 0},


	{0x79, DSER_ID, 0x02, 0x0F, 0x01, 0x10, 0},
	{0x79, DSER_ID, 0x02, 0x10, 0x01, 0xBE, 0},
	{0x79, DSER_ID, 0x02, 0x11, 0x01, 0x18, 0},


	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x22, 100},
	{0x79, DSER_ID, 0x00, 0x50, 0x01, 0x01, 100},
	{0x79, DSER_ID, 0x00, 0x01, 0x01, 0x02, 0},

	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x23, 0},
};


//kx11 config
unsigned char reg_cmds_set720[][7] = {
	{0x79, SERI_ID, 0x00, 0x02, 0x01, 0x73,  0},
	{0x79, SERI_ID, 0x00, 0x53, 0x01, 0x10,  0},
	{0x79, SERI_ID, 0x00, 0x57, 0x01, 0x20,  0},
	{0x79, SERI_ID, 0x03, 0x32, 0x01, 0x4e,  0},
	{0x79, SERI_ID, 0x03, 0x33, 0x01, 0xe4,  0},
	{0x79, SERI_ID, 0x00, 0x04, 0x01, 0xf2,  0},
	{0x79, SERI_ID, 0x03, 0x08, 0x01, 0x5c,  0},
	{0x79, SERI_ID, 0x03, 0x11, 0x01, 0x03,  0},
	{0x79, SERI_ID, 0x03, 0x31, 0x01, 0x03,  0},
	{0x79, SERI_ID, 0x03, 0x30, 0x01, 0x06,  0},
	{0x79, SERI_ID, 0x03, 0x1c, 0x01, 0x98,  0},
	{0x79, SERI_ID, 0x03, 0x21, 0x01, 0x24,  0},
	{0x79, SERI_ID, 0x03, 0x1d, 0x01, 0x98,  0},
	{0x79, SERI_ID, 0x03, 0x22, 0x01, 0x24,  0},
	{0x79, SERI_ID, 0x03, 0x26, 0x01, 0xe4,  0},
	{0x79, SERI_ID, 0x03, 0x85, 0x01, 0x40,  0},
	{0x79, SERI_ID, 0x03, 0x86, 0x01, 0x2d,  0},
	{0x79, SERI_ID, 0x03, 0x87, 0x01, 0x00,  0},
	{0x79, SERI_ID, 0x03, 0xa5, 0x01, 0x08,  0},
	{0x79, SERI_ID, 0x03, 0xa7, 0x01, 0x00,  0},
	{0x79, SERI_ID, 0x03, 0xa6, 0x01, 0x80,  0},
	{0x79, SERI_ID, 0x03, 0xa8, 0x01, 0xd0,  0},
	{0x79, SERI_ID, 0x03, 0xa9, 0x01, 0x02,  0},

	{0x79, SERI_ID, 0x03, 0xaa, 0x01, 0x2a,  0},
	{0x79, SERI_ID, 0x03, 0xac, 0x01, 0x04,  0},

	{0x79, SERI_ID, 0x03, 0xab, 0x01, 0x01,  0},
	{0x79, SERI_ID, 0x03, 0xad, 0x01, 0x00,  0},
	{0x79, SERI_ID, 0x03, 0xae, 0x01, 0x0f,  0},
	{0x79, SERI_ID, 0x03, 0xa4, 0x01, 0xc3,  0},//0xc1
	{0x79, SERI_ID, 0x03, 0x2a, 0x01, 0x07,  0},
	{0x79, SERI_ID, 0x00, 0x02, 0x01, 0x73,  0},
	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x23, 100},

	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x21, 100},
	{0x79, DSER_ID, 0x01, 0xCE, 0x01, 0x5F, 100},//5F
	{0x79, DSER_ID, 0x00, 0x01, 0x01, 0x02, 0},
	{0x79, DSER_ID, 0x00, 0x73, 0x01, 0x31, 0},
	{0x79, DSER_ID, 0x00, 0x7b, 0x01, 0x31, 0},

	{0x79, DSER_ID, 0x02, 0x10, 0x01, 0xBE, 0},
	{0x79, DSER_ID, 0x02, 0x11, 0x01, 0x18, 0},

	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x22, 100},
	{0x79, DSER_ID, 0x00, 0x50, 0x01, 0x00, 100},
	{0x79, DSER_ID, 0x01, 0xCE, 0x01, 0x5F, 100},//0x5F
	{0x79, DSER_ID, 0x00, 0x01, 0x01, 0x02, 0},
	{0x79, SERI_ID, 0x00, 0x01, 0x01, 0x08, 0},

	{0x79, DSER_ID, 0x02, 0x10, 0x01, 0xBE, 0},
	{0x79, DSER_ID, 0x02, 0x11, 0x01, 0x18, 0},

	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x23, 100},

};

//dcy11 config
unsigned char reg_cmds_set1920[][7] = {
	{0x79, SERI_ID, 0x03, 0x80, 0x01, 0x0f, 10}, // serial sync mode auto ,low level active
	{0x79, SERI_ID, 0x00, 0x02, 0x01, 0x73, 0},
	//{0x79, SERI_ID, 0x00, 0x53, 0x01, 0x10, 0},//packets tx over GMSLA in splitter mode.channel 0--stream ID 0.
	{0x79, SERI_ID, 0x00, 0x57, 0x01, 0x21, 0},//packet tx over GMSLB in splitter mode.channel 1--stream ID 1.
	//{0x79, SERI_ID, 0x03, 0x32, 0x01, 0x4e, 0},//PORTA:PHY1 D1 is lane 1.PHY0 D0 is lane 3.
	//{0x79, SERI_ID, 0x03, 0x33, 0x01, 0xe4, 0},//PORTB:PHY3 D0 is lane 2.PHY2 D1 is lane 1.
	{0x79, SERI_ID, 0x00, 0x04, 0x01, 0xf2, 0},//enable LINKA/B.GMSL2 type set.
	{0x79, SERI_ID, 0x03, 0x08, 0x01, 0x5c, 0},//DSI on portA enabled.
	{0x79, SERI_ID, 0x03, 0x11, 0x01, 0x03, 0},
	{0x79, SERI_ID, 0x03, 0x31, 0x01, 0x03, 0},//4 data lanes for PORTA.
	{0x79, SERI_ID, 0x03, 0x30, 0x01, 0x06, 0},//Two Ports with four data lanes each. Both Port A and Port B enabled.
	{0x79, SERI_ID, 0x03, 0x1c, 0x01, 0x98, 0},
	{0x79, SERI_ID, 0x03, 0x21, 0x01, 0x24, 0},
	{0x79, SERI_ID, 0x03, 0x1d, 0x01, 0x98, 0},
	{0x79, SERI_ID, 0x03, 0x22, 0x01, 0x24, 0},
	//{0x79, SERI_ID, 0x03, 0x26, 0x01, 0xe4, 0},
	{0x79, SERI_ID, 0x03, 0x85, 0x01, 0x28, 0},//hsync.the same as dts dsi timing set.
	{0x79, SERI_ID, 0x03, 0x86, 0x01, 0x05, 0},//vsync.the same as dts dsi timing set.
	//{0x79, SERI_ID, 0x03, 0x87, 0x01, 0x00, 0},
	{0x79, SERI_ID, 0x03, 0xa5, 0x01, 0x05, 0},//low byte of vfp.
	//{0x79, SERI_ID, 0x03, 0xa7, 0x01, 0x00, 0},//high byte of vbp.
	{0x79, SERI_ID, 0x03, 0xa6, 0x01, 0x50, 0},//[3:0]high nibble of vfp. [7:4]low nibble of vbp.
	{0x79, SERI_ID, 0x03, 0xa8, 0x01, 0x38, 0},// low byte of v-active.
	{0x79, SERI_ID, 0x03, 0xa9, 0x01, 0x04, 0},//High nibble of vertical active size

	{0x79, SERI_ID, 0x03, 0xaa, 0x01, 0x88, 0},//low byte of hfp.
	{0x79, SERI_ID, 0x03, 0xac, 0x01, 0x02, 0},//high byte of hbp.
	{0x79, SERI_ID, 0x03, 0xab, 0x01, 0x82, 0},//[3:0]high nibble of hfp. [7:4]low nibble of hbp.

	//{0x79, SERI_ID, 0x03, 0xad, 0x01, 0x00, 0},//Low byte of horizontal active size
	{0x79, SERI_ID, 0x03, 0xae, 0x01, 0x0f, 0},//High bits of horizontal active size
	{0x79, SERI_ID, 0x03, 0xa4, 0x01, 0xc1, 0},//0xc1
	{0x79, SERI_ID, 0x03, 0x2a, 0x01, 0x07, 0},//Dual-view processing enabled.
#if 1 //must keep in order to avoid blurry display.
	//#ASYM_REGS
	{0x79, SERI_ID, 0x7, 0x00, 0x01, 0x74 , 0x0},
	{0x79, SERI_ID, 0x7, 0x01, 0x01, 0x29 , 0x0},
	{0x79, SERI_ID, 0x7, 0x02, 0x01, 0x26 , 0x0},
	{0x79, SERI_ID, 0x7, 0x03, 0x01, 0x74 , 0x0},
	{0x79, SERI_ID, 0x7, 0x04, 0x01, 0x29 , 0x0},
	{0x79, SERI_ID, 0x7, 0x05, 0x01, 0x26 , 0x0},
	{0x79, SERI_ID, 0x7, 0x06, 0x01, 0xE8 , 0x0},
	{0x79, SERI_ID, 0x7, 0x07, 0x01, 0x52 , 0x0},
	{0x79, SERI_ID, 0x7, 0x08, 0x01, 0x4C , 0x0},
	//{0x79, SERI_ID, 0x7, 0x09, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x0A, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x0B, 0x01, 0x80 , 0x0},
	{0x79, SERI_ID, 0x7, 0x0C, 0x01, 0x07 , 0x0},
	{0x79, SERI_ID, 0x7, 0x0D, 0x01, 0x38 , 0x0},
	{0x79, SERI_ID, 0x7, 0x0E, 0x01, 0x04 , 0x0},
	{0x79, SERI_ID, 0x7, 0x0F, 0x01, 0x80 , 0x0},
	{0x79, SERI_ID, 0x7, 0x10, 0x01, 0x07 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x11, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x12, 0x01, 0x0F , 0x0},
	{0x79, SERI_ID, 0x7, 0x13, 0x01, 0x38 , 0x0},
	{0x79, SERI_ID, 0x7, 0x14, 0x01, 0x04 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x15, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x16, 0x01, 0xd0 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x17, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x18, 0x01, 0xd0 , 0x0},

	//#ASYM_READ_REGS_A
	{0x79, SERI_ID, 0x7, 0x20, 0x01, 0x3C , 0x0},
	{0x79, SERI_ID, 0x7, 0x21, 0x01, 0xD0 , 0x0},
	{0x79, SERI_ID, 0x7, 0x22, 0x01, 0x25 , 0x0},
	{0x79, SERI_ID, 0x7, 0x23, 0x01, 0x9C , 0x0},
	{0x79, SERI_ID, 0x7, 0x24, 0x01, 0x2C , 0x0},
	//{0x79, SERI_ID, 0x7, 0x25, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x26, 0x01, 0x9C , 0x0},
	{0x79, SERI_ID, 0x7, 0x27, 0x01, 0x2C , 0x0},
	//{0x79, SERI_ID, 0x7, 0x28, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x29, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x2A, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x2B, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x2C, 0x01, 0x14 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x2D, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x2E, 0x01, 0xD8 , 0x0},
	{0x79, SERI_ID, 0x7, 0x2F, 0x01, 0x08 , 0x0},
	{0x79, SERI_ID, 0x7, 0x30, 0x01, 0x47 , 0x0},
	{0x79, SERI_ID, 0x7, 0x31, 0x01, 0x04 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x32, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x33, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x34, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x35, 0x01, 0x28 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x36, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x37, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x38, 0x01, 0x80 , 0x0},
	{0x79, SERI_ID, 0x7, 0x39, 0x01, 0x07 , 0x0},
	{0x79, SERI_ID, 0x7, 0x3A, 0x01, 0x6C , 0x0},
	{0x79, SERI_ID, 0x7, 0x3B, 0x01, 0x01 , 0x0},
	{0x79, SERI_ID, 0x7, 0x3C, 0x01, 0x38 , 0x0},
	{0x79, SERI_ID, 0x7, 0x3D, 0x01, 0x04 , 0x0},
	{0x79, SERI_ID, 0x7, 0x3E, 0x01, 0xAC , 0x0},
	{0x79, SERI_ID, 0x7, 0x3F, 0x01, 0x85 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x40, 0x01, 0x00 , 0x0},
	//#ASYM_READ_REGS_B
	{0x79, SERI_ID, 0x7, 0x50, 0x01, 0x3C , 0x0},
	{0x79, SERI_ID, 0x7, 0x51, 0x01, 0xD0 , 0x0},
	{0x79, SERI_ID, 0x7, 0x52, 0x01, 0x25 , 0x0},
	{0x79, SERI_ID, 0x7, 0x53, 0x01, 0x9C , 0x0},
	{0x79, SERI_ID, 0x7, 0x54, 0x01, 0x2C , 0x0},
	//{0x79, SERI_ID, 0x7, 0x55, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x56, 0x01, 0x9C , 0x0},
	{0x79, SERI_ID, 0x7, 0x57, 0x01, 0x2C , 0x0},
	//{0x79, SERI_ID, 0x7, 0x58, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x59, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x5A, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x5B, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x5C, 0x01, 0x14 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x5D, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x5E, 0x01, 0xD8 , 0x0},
	{0x79, SERI_ID, 0x7, 0x5F, 0x01, 0x08 , 0x0},
	{0x79, SERI_ID, 0x7, 0x60, 0x01, 0x47 , 0x0},
	{0x79, SERI_ID, 0x7, 0x61, 0x01, 0x04 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x62, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x63, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x64, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x65, 0x01, 0x28 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x66, 0x01, 0x00 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x67, 0x01, 0x00 , 0x0},
	{0x79, SERI_ID, 0x7, 0x68, 0x01, 0x80 , 0x0},
	{0x79, SERI_ID, 0x7, 0x69, 0x01, 0x07 , 0x0},
	{0x79, SERI_ID, 0x7, 0x6A, 0x01, 0x6C , 0x0},
	{0x79, SERI_ID, 0x7, 0x6B, 0x01, 0x01 , 0x0},
	{0x79, SERI_ID, 0x7, 0x6C, 0x01, 0x38 , 0x0},
	{0x79, SERI_ID, 0x7, 0x6D, 0x01, 0x04 , 0x0},
	{0x79, SERI_ID, 0x7, 0x6E, 0x01, 0xAC , 0x0},
	{0x79, SERI_ID, 0x7, 0x6F, 0x01, 0x85 , 0x0},
	//{0x79, SERI_ID, 0x7, 0x70, 0x01, 0x00 , 0x0},
	//#Select LUT pattern/ Enable ASYM
	{0x79, SERI_ID, 0x7, 0x19, 0x01, 0x17 , 0x0},
#endif //
	//{0x79, SERI_ID, 0x00, 0x02, 0x01, 0x73, 0},
	//{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x23, 50},

	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x21, 50},//reset_one_shot,select linkA
	{0x79, DSER_ID, 0x01, 0xCE, 0x01, 0x5F, 0},//vesa format,4lanes,porta/b swapped,enable splitter.
	{0x79, DSER_ID, 0x00, 0x01, 0x01, 0x02, 0},//rx_rate = 6gbps.active after next link reset.

	//{0x79, DSER_ID, 0x00, 0x73, 0x01, 0x31, 0},
	//{0x79, DSER_ID, 0x00, 0x7b, 0x01, 0x31, 0},

	{0x79, DSER_ID, 0x02, 0x0F, 0x01, 0x10, 0},//GPIO A pull high.
	{0x79, DSER_ID, 0x02, 0x10, 0x01, 0xBE, 0},
	{0x79, DSER_ID, 0x02, 0x11, 0x01, 0x18, 0},
	//{0x79, DSER_ID, 0x00, 0x00, 0x01, 0x94, 0},

	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x22, 30},//reset_one_shot,select linkB

	{0x79, SERI_ID, 0x00, 0x03, 0x01, 0x50, 0},// Pass-through UART Channel 1 enabled.
	{0x79, SERI_ID, 0x00, 0x4F, 0x01, 0x08, 0},
	{0x79, SERI_ID, 0x05, 0x48, 0x01, 0x8B, 0},
	{0x79, SERI_ID, 0x05, 0x49, 0x01, 0x02, 0},
	{0x79, SERI_ID, 0x00, 0x4d, 0x01, 0x5e, 0},
	{0x79, DSER_ID, 0x00, 0x03, 0x01, 0x24, 0},//uart,enable pass-through for channel 1.
	{0x79, DSER_ID, 0x00, 0x4F, 0x01, 0x08, 0},
	{0x79, DSER_ID, 0x02, 0x4A, 0x01, 0x8B, 0},
	{0x79, DSER_ID, 0x02, 0x4B, 0x01, 0x02, 0},

	{0x79, DSER_ID, 0x00, 0x50, 0x01, 0x01, 0},//receive packets with stream ID 1.
	{0x79, DSER_ID, 0x01, 0xCE, 0x01, 0x5F, 0},//0x5F
	{0x79, DSER_ID, 0x00, 0x01, 0x01, 0x02, 0},//rx_rate = 6gbps.active after next link reset.
	{0x79, SERI_ID, 0x00, 0x01, 0x01, 0x08, 0},//tx_rate = 6gbps.active after next link reset.

	{0x79, DSER_ID, 0x02, 0x10, 0x01, 0xBE, 0},
	{0x79, DSER_ID, 0x02, 0x11, 0x01, 0x18, 0},
	{0x79, DSER_ID, 0x02, 0x0F, 0x01, 0x10, 0},

	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x23, 0},//reset_one_shot,splitter mode.
	//{0x79, DSER_ID, 0x02, 0x0F, 0x01, 0x10, 0},
};

unsigned char reg_cmds_sdpic[][7] = {
	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x23, 100},
	{0x79, DSER_ID, 0x02, 0x0F, 0x01, 0x10, 0},
};

unsigned char reg_cmds_refresh[][7] = {
	{0x79, DSER_ID, 0x00, 0x10, 0x01, 0x31, 100},
	//{0x79, DSER_ID, 0x02, 0x0F, 0x01, 0x10, 0},
};


unsigned char reg_cmds_set_96789[][7] = {
	{0x79, SERI_ID, 0x03, 0x80, 0x01, 0x0f, 0}, // serial sync mode auto ,low level active
	{0x79, DSER_ID, 0x00, 0x01, 0x01, 0x02, 0}, // rx_rate:6gbps
	{0x79, DSER_ID, 0x01, 0xCE, 0x01, 0x5F, 100},   // VESA format
	{0x79, SERI_ID, 0x00, 0x01, 0x01, 0x08, 5},   // tx_rate: 6gbps
	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x31, 100}, // reset oneshot
	{0x79, DSER_ID, 0x02, 0x0F, 0x01, 0x10, 0}, // enable back light
	{0x79, DSER_ID, 0x02, 0x10, 0x01, 0xBE, 0},
	{0x79, DSER_ID, 0x02, 0x11, 0x01, 0x18, 0},
};

unsigned char reg_cmds_set_kx11[][7] = {
	{0x79, SERI_ID, 0x00, 0x01, 0x01, 0x08,  5},   // tx_rate: 6gbps
	{0x79, SERI_ID, 0x00, 0x10, 0x01, 0x31, 100}, // reset oneshot
};

static bool se_serdes_suspend = false;

static int uart_detect_deserialiser(const struct device *dev, struct uart_port *port)
{
       const static unsigned char detect_des[] = {0x79, MAX96752_UART_READ_ADDR, 0x00, 0x0D, 0x01};
       int i = 0;
       unsigned char rx_buf[2];

       for (i = 0; i < 5; i++)
            port->ops->poll_put_char(port, detect_des[i]);

       mdelay(1);
       rx_buf[0] = port->ops->poll_get_char(port);
       mdelay(1);
       rx_buf[1] = port->ops->poll_get_char(port);
       if (rx_buf[1] == 0x00) {
            dev_err(dev, "not detect desrialiser, device id = 0x%x", rx_buf[1]);
            return -1;
       }
       dev_dbg(dev, "detect desrialiser, device id = 0x%x", rx_buf[1]);
       return 0;
}

static void panel_power_on(const struct device *dev, struct uart_port *port)
{
	int i;
	unsigned char power_on_cmd[] = {0x79, 0x55, 0xaa, 0x00,
					0x00, 0x05, 0x01, 0x00,
					0x01, 0x00, 0x7f};
	int len = ARRAY_SIZE(power_on_cmd);

	for (i = 0; i < len; i++)
		port->ops->poll_put_char(port, power_on_cmd[i]);

	dev_info(dev, "panel power on done!");
}

static int max96789_init(struct device *dev)
{
	struct device_node *uart_np;
	struct platform_device *uart_pdev;
	struct uart_port *port;
	u32 i, j;
	unsigned char rx_buf;
	unsigned int delay_set;
	long baudrate = 0;
	int retry;
	const char *uart_cfg;
	const char *serializer_type;

	uart_np = of_parse_phandle(dev->of_node, "uart-dev", 0);
	if (!uart_np) {
		dev_err(dev, "Failed to get uart-dev \n");
		return -EINVAL;
	}

	uart_pdev = of_find_device_by_node(uart_np);
	of_node_put(uart_np);

	if (!uart_pdev) {
		dev_err(dev, "Failed to get uart pdev \n");
		return -EINVAL;
	}

	port = dw8250_get_port(uart_pdev);
	if (!port) {
		dev_err(dev, "Failed to get uart pdev \n");
		return -EINVAL;
	}

	if (of_property_read_string(dev->of_node, "uart-config", &uart_cfg)) {
		dev_err(dev, " get uart-config fail in dts\n");
		return -EINVAL;
	}

	if (of_property_read_string(dev->of_node, "serializer-type", &serializer_type)) {
		dev_err(dev, " get serializer-type fail in dts\n");
		return -EINVAL;
	}

	/* Get baud_rate and set it up */
	for (i = 0; i < strlen(uart_cfg); i++) {
		if ('0' > uart_cfg[i] || '9' < uart_cfg[i])
			break;
		baudrate = baudrate * 10 + uart_cfg[i] - '0';
	}

	printk("serdes baud %ld\n", baudrate);

	uart_set_options(port, NULL, baudrate, 'e', 8, 'n');

	if (!(strcmp(serializer_type, "max96789"))) {

		for (i = 0; i < sizeof(reg_cmds_set_96789)/sizeof(reg_cmds_set_96789[0]); i++) {
			for (retry = 0; retry < 5; retry++) {
				for (j = 0; j < 6; j++)
					port->ops->poll_put_char(port, reg_cmds_set_96789[i][j]);

				delay_set = reg_cmds_set_96789[i][6];
				if(delay_set)
					msleep(delay_set);

				rx_buf = port->ops->poll_get_char(port);
				if (rx_buf == 0xc3)
					break;

				//dev_info(dev, "write addr:0x%02x%02x val:0x%x, read:0x%x pass\n",
				//reg_cmds_set_96789[i][2], reg_cmds_set_96789[i][3], reg_cmds_set_96789[i][5], rx_buf);
			}
			if(!delay_set)
				msleep(1);
		}

	}


	if (!(strcmp(serializer_type, "max96789_1920"))) {
		if(!se_serdes_suspend) {
			if (uart_detect_deserialiser(dev, port))
				return 0;
		}

		for (i = 0; i < sizeof(reg_cmds_set1920)/sizeof(reg_cmds_set1920[0]); i++) {
			for (retry = 0; retry < 5; retry++) {
				for (j = 0; j < 6; j++)
					port->ops->poll_put_char(port, reg_cmds_set1920[i][j]);

				delay_set = reg_cmds_set1920[i][6];
				if(delay_set)
					mdelay(delay_set);
				else
					udelay(500);//mdelay(1);

				rx_buf = port->ops->poll_get_char(port);
				if (rx_buf == 0xc3)
					break;

			}
			if(retry == 5) {
				dev_err(dev, "write addr:0x%02x%02x val:0x%x, read:0x%x fail\n",
				reg_cmds_set1920[i][2], reg_cmds_set1920[i][3], reg_cmds_set1920[i][5], rx_buf);
			}

		}
	}

	if (!(strcmp(serializer_type, "max96789_720"))) {
		for (i = 0; i < sizeof(reg_cmds_set720)/sizeof(reg_cmds_set720[0]); i++) {
			for (retry = 0; retry < 5; retry++) {
				for (j = 0; j < 6; j++)
				port->ops->poll_put_char(port, reg_cmds_set720[i][j]);

				delay_set = reg_cmds_set720[i][6];
				if(delay_set)
					msleep(delay_set);

				rx_buf = port->ops->poll_get_char(port);
				if (rx_buf == 0xc3)
					break;

				//dev_info(dev, "write addr:0x%02x%02x val:0x%x, read:0x%x pass\n",
				//reg_cmds_set720[i][2], reg_cmds_set720[i][3], reg_cmds_set720[i][5], rx_buf);
			}
			if(!delay_set)
				msleep(1);
		}
	}

	if (!(strcmp(serializer_type, "max96789_asym"))) {
		for(i = 0; i < sizeof(reg_cmds_asym)/sizeof(reg_cmds_asym[0]); i++) {
			for (retry = 0; retry < 5; retry++) {
				for(j = 0; j < 6; j++)
					port->ops->poll_put_char(port,reg_cmds_asym[i][j]);

				delay_set = reg_cmds_asym[i][6];
				if(delay_set)
					msleep(delay_set);

				rx_buf = port->ops->poll_get_char(port);
				if(rx_buf == 0xc3)
					break;

				//dev_info(dev,"write addr:0x%02x%02x val:0x%x, read:0x%x fail\n",
				//reg_cmds_asym[i][2], reg_cmds_asym[i][3], reg_cmds_asym[i][5], rx_buf);
			}
			if(!delay_set)
				msleep(1);
		}
	}


	if (!(strcmp(serializer_type, "max96789_kx11"))) {
		for (i = 0; i < sizeof(reg_cmds_set_kx11)/sizeof(reg_cmds_set_kx11[0]); i++) {
			for (retry = 0; retry < 5; retry++) {
				for (j = 0; j < 6; j++)
				port->ops->poll_put_char(port, reg_cmds_set_kx11[i][j]);

				delay_set = reg_cmds_set_kx11[i][6];
				if(delay_set)
					msleep(delay_set);

				rx_buf = port->ops->poll_get_char(port);
				if (rx_buf == 0xc3)
					break;

				//dev_info(dev, "write addr:0x%02x%02x val:0x%x, read:0x%x pass\n",
				//reg_cmds_set_kx11[i][2], reg_cmds_set_kx11[i][3], reg_cmds_set_kx11[i][5], rx_buf);
			}
			if(!delay_set)
				msleep(1);
		}
	}

	if(!se_serdes_suspend) {
		panel_power_on(dev, port);
	}

return 0;
}

static int se_maxim_serdes_probe(struct platform_device *pdev)
{
	struct device *dev = &pdev->dev;
	int ret = 0;
	se_serdes_suspend = false;
	ret = max96789_init(dev);
	if (ret < 0) {
		dev_err(dev, "max96xx init fail (%d)\n", ret);
		//return ret;
	}

	return 0;
}

static int se_maxim_serdes_remove(struct platform_device *pdev)
{
	return 0;
}

static void se_maxim_serdes_shutdown(struct platform_device *pdev)
{}

#ifdef CONFIG_PM_SLEEP
static int se_maxim_serdes_resume(struct device *dev)
{
	struct device_node *np = dev->of_node;
	const char *serializer_type;
	char str[] = "max96789";
	int ret = 0;

	dev_dbg(dev, " se_maxim_serdes_resume... \n");

	if (of_property_read_string(np, "serializer-type", &serializer_type)) {
		dev_err(dev, " get serializer-type fail in dts\n");
		return -EINVAL;
	}
	if (strstr(serializer_type, str) != NULL) {
		ret = max96789_init(dev);
		if (ret < 0)
			dev_err(dev, "fail to init max96789 (%d)\n", ret);
	}
	if(se_serdes_suspend)
		se_serdes_suspend = FALSE;

	return 0;
}

static int se_maxim_serdes_suspend(struct device *dev)
{
	dev_dbg(dev, " se_maxim_serdes_suspend... \n");
	se_serdes_suspend = TRUE;
	return 0;
}

static const struct of_device_id se_serdes_of_match[] = {
	{ .compatible = "siengine,max96789-serdes", },
	{ /* sentinel */ }
};
MODULE_DEVICE_TABLE(of, se_serdes_of_match);

static const struct dev_pm_ops se_maxim_serdes_pm = {
	SET_SYSTEM_SLEEP_PM_OPS(se_maxim_serdes_suspend, se_maxim_serdes_resume)
};
#endif /* CONFIG_PM_SLEEP */

static struct platform_driver se_maxim_serdes_platform_driver = {
	.driver = {
		.name = "serdes-siengine-max96789",
		.of_match_table = se_serdes_of_match,
		#ifdef CONFIG_PM_SLEEP
		.pm = &se_maxim_serdes_pm,
		#endif
	},
	.probe = se_maxim_serdes_probe,
	.remove = se_maxim_serdes_remove,
	.shutdown = se_maxim_serdes_shutdown,
};

module_platform_driver(se_maxim_serdes_platform_driver);


MODULE_AUTHOR("liam chen<liam.chen@siengine.com>");
MODULE_DESCRIPTION("Siengine max96789 serdes driver");
MODULE_VERSION("1.0");
MODULE_LICENSE("GPL");

